# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**@enalmada/start-secure** is a security header management library for TanStack Start applications. It provides a middleware wrapper that automatically applies secure HTTP headers, with a focus on Content Security Policy (CSP) management.

## Commands

### Build
```bash
bun run build              # Clean, build bundle (ESM + CJS), and generate types
bun run build:bundle       # Build ESM and CJS bundles only
bun run build:declaration  # Generate TypeScript declaration files only
bun run clean             # Remove dist directory
```

### Test
```bash
bun run test              # Run all tests once
bun run test:watch        # Run tests in watch mode
```

### Linting & Type Checking
```bash
bun run lint              # Run Biome linter with auto-fix
bun run type-check        # TypeScript type checking without emitting files
```

### Publishing
```bash
bun run release           # Build and publish with changesets
```

## Architecture

### Core Components

**Handler Layer** (`src/handler.ts`)
- `createSecureHandler()` - Higher-order function that wraps TanStack Start handlers
- Returns middleware that applies security headers to all responses
- Entry point for consumers of the library

**Generator** (`src/internal/generator.ts`)
- `generateSecurityHeaders()` - Generates complete security headers from CSP rules
- Handles nonce support and environment-specific adjustments (dev vs prod)
- Combines CSP directives with other security headers

**Merger** (`src/internal/merger.ts`)
- `mergeCspRules()` - Merges multiple CSP rules with automatic deduplication using Sets
- `mergeDirectivesWithDefaults()` - Combines user rules with default directives
- Ensures 'self' is added to new directives not present in defaults

**Defaults** (`src/internal/defaults.ts`)
- `getDefaultCspDirectives()` - Returns base CSP directives with environment adjustments
- `defaultSecurityHeadersConfig` - Strict default security headers (X-Frame-Options, HSTS, etc.)
- Dev mode automatically adds: `'unsafe-eval'` for script-src, `ws://localhost:*` for HMR

### Key Design Patterns

**CSP Rule Merging Logic**
1. Default directives are initialized as Sets for deduplication
2. User rules are merged on top, adding values to existing Sets
3. New directives from user rules automatically get `'self'` added
4. Final CSP is generated by joining Set values with spaces

**Nonce Handling**
- When nonce is provided: adds `'nonce-{value}'` and `'strict-dynamic'` to script-src, removes `'unsafe-inline'`
- When no nonce: falls back to `'unsafe-inline'` (TanStack Start limitation)
- Nonce is also added to style-src when provided
- Nonce is exposed via `x-nonce` header for client-side access

**Development vs Production**
- isDev flag (defaults to `process.env.NODE_ENV !== 'production'`)
- Dev mode adds WebSocket support for HMR and `'unsafe-eval'` for dev tools
- Production mode enforces stricter CSP

### Build System

**Dual Format Build** (`build.ts`)
- Uses Bun.build to generate both ESM (.mjs) and CJS (.js) outputs
- External dependency: `@tanstack/*` (peer dependency)
- TypeScript declarations generated separately via `tsc --emitDeclarationOnly`
- Source maps generated for both formats

### Testing Approach

Tests are in `test/index.test.ts` and cover:
- Default header generation
- CSP rule merging and deduplication
- Nonce support
- Dev mode adjustments
- Custom header configuration
- Handler middleware behavior (preserving response body/status)

Run individual test files:
```bash
bun test test/index.test.ts
```

## Important Implementation Notes

1. **TanStack Start Nonce Limitation**: The framework doesn't yet support nonces natively in its rendering pipeline. The library provides nonce configuration but consumers must manually inject nonces into script/style tags.

2. **CSP Directive Initialization**: When user rules include directives not in defaults, the merger automatically adds `'self'` to maintain security (see `mergeDirectivesWithDefaults` in `src/internal/merger.ts:58-61`).

3. **Header Merging Order**: Custom `headerConfig` overrides defaults, allowing consumers to relax or customize any security header (see `src/internal/generator.ts:35-38`).

4. **Type Exports**: All types are exported from `src/index.ts` for consumer use, including internal types for advanced customization.
