# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**@enalmada/start-secure** is a security header management library for TanStack Start applications. It provides a middleware wrapper that automatically applies secure HTTP headers, with a focus on Content Security Policy (CSP) management.

## Commands

### Development
```bash
bun test                  # Run all tests once
bun test:watch            # Run tests in watch mode
bun run type-check        # TypeScript type checking without emitting files
bun run lint              # Run Biome linter with auto-fix
bun run check             # Run lint, type-check, and test (via turbo)
```

### Build
```bash
bun run build             # Full build: type-check → clean → bundle → declarations
bun run build:bundle      # Build ESM and CJS bundles only
bun run build:declaration # Generate TypeScript declaration files only
bun run clean             # Remove dist directory
```

### Publishing
```bash
bun run release           # Build and publish with changesets
```

## Architecture

### Core Components

**Handler Layer** (`src/handler.ts`)
- `createSecureHandler()` - Higher-order function that wraps TanStack Start handlers
- Memoizes security headers at middleware creation time (not per-request) for performance
- Clones response with explicit options to avoid stream consumption issues

**Generator** (`src/internal/generator.ts`)
- `generateSecurityHeaders()` - Generates complete security headers from CSP rules
- Validates nonce format (min 24 chars base64, logs warnings if invalid)
- Filters `undefined` values from `headerConfig` to prevent accidental default overwrites
- Warns when CSP headers exceed size limits (>4KB, >8KB)

**Merger** (`src/internal/merger.ts`)
- `mergeCspRules()` - Merges multiple CSP rules with automatic deduplication using Sets
- Handles boolean directives: `true`/`''` → enable, `false` → omit
- Validates dangerous values (`'unsafe-eval'`, `'unsafe-inline'`, wildcards) with warnings
- Trims whitespace from array values to prevent injection
- Auto-adds `'self'` to source-list directives (excludes special directives like `report-uri`, `sandbox`)

**Defaults** (`src/internal/defaults.ts`)
- `getDefaultCspDirectives()` - Returns base CSP directives with environment adjustments
- `defaultSecurityHeadersConfig` - Strict default security headers (X-Frame-Options, HSTS with preload, Permissions-Policy)
- `validateNonce()` - Exported utility for nonce validation

### Key Design Patterns

**CSP Rule Merging Logic**
1. Default directives are initialized as Sets for deduplication
2. User rules are merged on top, adding values to existing Sets
3. New directives from user rules automatically get `'self'` added
4. Final CSP is generated by joining Set values with spaces

**Nonce Handling**
- When nonce is provided: adds `'nonce-{value}'` to script-src and style-src, replaces `'unsafe-inline'`
- Adds `'strict-dynamic'` to script-src when using nonce (modern CSP approach)
- When no nonce: falls back to `'unsafe-inline'` (TanStack Start limitation - see https://github.com/TanStack/router/discussions/3028)
- Nonce is exposed via `x-nonce` header for client-side access
- Validation: min 24 chars base64, logs warnings for invalid format

**Environment-Specific Behavior**
- Dev mode: Adds `'unsafe-eval'` (dev tools), `ws://localhost:*` and `wss://localhost:*` (HMR)
- Production: Strict CSP without eval or unsafe-inline (when nonce provided)
- `isDev` defaults to `process.env.NODE_ENV !== 'production'`

**Response Cloning** (Critical for TanStack Start)
```typescript
// Avoid stream consumption issues by cloning with explicit options
const newResponse = new Response(response.body, {
  status: response.status,
  statusText: response.statusText,
  headers: response.headers,
});
```

### Build System

**Dual Format Build** (`build.ts`)
- Uses Bun.build to generate both ESM (.mjs) and CJS (.js) outputs
- External dependency: `@tanstack/*` (peer dependency)
- TypeScript declarations generated separately via `tsc --emitDeclarationOnly`
- Package marked `sideEffects: false` for tree-shaking

### Testing

Tests are in `test/index.test.ts` using Vitest. Key categories:
- Default header generation and merging
- CSP rule deduplication
- Boolean directive handling (`true`/`false`/`''`)
- Nonce support and validation
- Dev vs production mode
- Custom header config (including undefined value filtering)
- Response preservation (body, status, headers)
- Error propagation

Note: Nonce validation warnings during tests are expected (test nonces are intentionally short).

## Important Implementation Notes

1. **TanStack Start Nonce Limitation**: The framework doesn't yet support nonces natively in its rendering pipeline. The library provides nonce configuration but consumers must manually inject nonces into script/style tags.

2. **CSP Directive Types**:
   - Source lists: Accept `string` or `readonly string[]` (e.g., `'connect-src': 'https://api.example.com'`)
   - Boolean directives: Accept `true`, `false`, or `''` (e.g., `'upgrade-insecure-requests': true`)
   - Special directives (`report-uri`, `sandbox`, `trusted-types`, etc.) don't auto-add `'self'`

3. **Header Config Filtering**: The generator filters out `undefined` values from `headerConfig` to prevent accidental override of secure defaults. Only explicitly set values (including `null` or empty string) will override.

4. **Validation & Warnings**: The library logs console warnings for security issues (dangerous CSP values, large headers, invalid nonces). These are intentional and should not be suppressed in development.

5. **Performance**: Security headers are memoized at middleware creation time, not generated per-request. This is critical for production performance.
